name: CI - Test Minecraft Build

# Se activa SOLO en Pull Requests
on:
  pull_request:
    branches: [ "main" ]

jobs:
  test-server-startup:
    runs-on: ubuntu-latest
    environment: Deploy
    steps:
      - name: ğŸ“¥ Bajar cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ³ Construir imagen Docker (Test Build)
        run: docker build -t minecraft-test:pr-${{ github.event.number }} .

      - name: âš™ï¸ Extraer Mods y Plugins de Helm
        id: config
        uses: mikefarah/yq@master
        with:
          cmd: |
            MODS=$(yq '.minecraftServer.modUrls | join(",")' helm/minecraft-values.yaml)
            PLUGINS=$(yq '.minecraftServer.pluginUrls | join(",")' helm/minecraft-values.yaml)
            echo "mods=$MODS" >> $GITHUB_OUTPUT
            echo "plugins=$PLUGINS" >> $GITHUB_OUTPUT

      - name: ğŸ§ª Ejecutar "Smoke Test" (Arrancar servidor)
        timeout-minutes: 10
        run: |
          echo "Iniciando servidor de prueba con MODS y PLUGINS..."
          
          docker run -d --name mc-test \
            -e EULA=TRUE \
            -e TYPE=MOHIST \
            -e VERSION=1.20.1 \
            -e MEMORY=6G \
            -e MODS="${{ steps.config.outputs.mods }}" \
            -e PLUGINS="${{ steps.config.outputs.plugins }}" \
            minecraft-test:pr-${{ github.event.number }}

          # Esperamos a ver seÃ±ales de vida en los logs
          echo "Esperando a que el servidor arranque (esto puede tardar unos minutos)..."
          
          # Bucle de verificaciÃ³n (Polling)
          # Busca "Done" (Ã©xito) o "Exception" (error)
          SUCCESS=0
          for i in {1..30}; do
            sleep 20
            echo "--- Revisando logs (Intento $i/30) ---"
            docker logs --tail 10 mc-test
            
            # Si encuentra "Done" o "Helpo", el server arrancÃ³ bien
            if docker logs mc-test 2>&1 | grep -q -E "Done \(|For help, type"; then
              echo "âœ… Â¡Ã‰XITO! El servidor arrancÃ³ correctamente."
              SUCCESS=1
              break
            fi
            
            # Si encuentra un crash report
            if docker logs mc-test 2>&1 | grep -q "Stopping server"; then
              echo "âŒ ERROR: El servidor se detuvo inesperadamente."
              docker logs mc-test
              exit 1
            fi
          done

          if [ $SUCCESS -eq 0 ]; then
            echo "âŒ TIMEOUT: El servidor no arrancÃ³ a tiempo o fallÃ³ silenciosamente."
            # Mostramos las Ãºltimas lÃ­neas para depurar
            docker logs --tail 100 mc-test
            exit 1
          fi

      - name: ğŸ§¹ Limpieza
        if: always() # Se ejecuta aunque falle
        run: docker rm -f mc-test
        

      - name: ğŸ”” Notificar Ã‰xito a Discord
        uses: rjstone/discord-webhook-notify@v1
        if: success()
        with:
          severity: info
          username: "Minecraft CI"
          details: |
            âœ… **Test Exitoso**: El servidor de prueba arrancÃ³ correctamente.
            ğŸ”¹ **PR**: #${{ github.event.number }} - ${{ github.event.pull_request.title }}
            ğŸ”¹ **Autor**: ${{ github.actor }}
            ğŸ”¹ **Job**: [Ver Logs en GitHub](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: ğŸš¨ Notificar Error a Discord
        uses: rjstone/discord-webhook-notify@v1
        if: failure()
        with:
          severity: error
          username: "Minecraft CI"
          details: |
            âŒ **Test FALLIDO**: El servidor no pudo arrancar.
            ğŸ”¸ **PR**: #${{ github.event.number }} - ${{ github.event.pull_request.title }}
            ğŸ”¸ **Autor**: ${{ github.actor }}
            ğŸ”¸ **Job**: [Ver Logs y Errores](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK_URL_PRIVATE }}

  test-gitops-sync:
    runs-on: ubuntu-latest
    needs: test-server-startup
    steps:
      - name: ğŸ“¥ Bajar cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ³ Construir imagen Docker (Reutilizar Layer Cache)
        run: docker build -t minecraft-test:pr-${{ github.event.number }} .

      - name: ğŸ§ª Test de SincronizaciÃ³n GitOps (InitContainer Simulation)
        run: |
          echo "Simulando entorno de persistencia..."
          mkdir -p fake-data/plugins/Essentials
          
          # 1. Crear config OBSOLETA (interval: 30)
          echo "backup:" > fake-data/plugins/Essentials/config.yml
          echo "  interval: 30" >> fake-data/plugins/Essentials/config.yml
          
          echo "ğŸ“ ConfiguraciÃ³n inicial (OBSOLETA):"
          cat fake-data/plugins/Essentials/config.yml
          
          # 2. Ejecutar Script de SincronizaciÃ³n como si fuera el initContainer
          # Montamos fake-data en /data y corremos el script
          printf "\nğŸ”„ Ejecutando sincronizaciÃ³n...\n"
          # Permisos para que el usuario 1000 (container) pueda escribir en el volumen host
          chmod -R 777 fake-data

          docker run --rm \
            -v $(pwd)/fake-data:/data \
            --user 0 \
            --entrypoint /usr/local/bin/gitops-entrypoint.sh \
            minecraft-test:pr-${{ github.event.number }}
            
          # 3. ValidaciÃ³n
          echo "ğŸ“ ConfiguraciÃ³n post-sync:"
          cat fake-data/plugins/Essentials/config.yml
          
          if grep -q "interval: 1440" fake-data/plugins/Essentials/config.yml; then
            echo "âœ… Â¡Ã‰XITO! El config.yml fue actualizado correctamente."
            exit 0
          else
            echo "âŒ FALLO: El config.yml NO fue actualizado. Sigue teniendo el valor antiguo."
            exit 1
          fi
