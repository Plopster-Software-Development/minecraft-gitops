name: CI - Test Minecraft Build

# Se activa SOLO en Pull Requests
on:
  pull_request:
    branches: [ "main" ]

jobs:
  test-server-startup:
    runs-on: ubuntu-latest
    environment: Deploy
    steps:
      - name: ğŸ“¥ Bajar cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ³ Construir imagen Docker (Test Build)
        run: docker build -t minecraft-test:pr-${{ github.event.number }} .

      - name: ğŸ§ª Ejecutar "Smoke Test" (Arrancar servidor)
        timeout-minutes: 10 # Si tarda mÃ¡s de 10 min, falla
        run: |
          echo "Iniciando servidor de prueba..."
          
          # Arrancamos el contenedor en segundo plano (-d)
          # Le damos 6GB de RAM al runner (tienen 7GB total)
          # Aceptamos EULA automÃ¡ticamente para que arranque
          docker run -d --name mc-test \
            -e EULA=TRUE \
            -e TYPE=FORGE \
            -e VERSION=1.20.1 \
            -e MEMORY=6G \
            minecraft-test:pr-${{ github.event.number }}

          # Esperamos a ver seÃ±ales de vida en los logs
          echo "Esperando a que el servidor arranque (esto puede tardar unos minutos)..."
          
          # Bucle de verificaciÃ³n (Polling)
          # Busca "Done" (Ã©xito) o "Exception" (error)
          SUCCESS=0
          for i in {1..30}; do
            sleep 20
            echo "--- Revisando logs (Intento $i/30) ---"
            
            # Si encuentra "Done" o "Helpo", el server arrancÃ³ bien
            if docker logs mc-test 2>&1 | grep -q -E "Done \(|For help, type"; then
              echo "âœ… Â¡Ã‰XITO! El servidor arrancÃ³ correctamente."
              SUCCESS=1
              break
            fi
            
            # Si encuentra un crash report
            if docker logs mc-test 2>&1 | grep -q "Stopping server"; then
              echo "âŒ ERROR: El servidor se detuvo inesperadamente."
              docker logs mc-test
              exit 1
            fi
          done

          if [ $SUCCESS -eq 0 ]; then
            echo "âŒ TIMEOUT: El servidor no arrancÃ³ a tiempo o fallÃ³ silenciosamente."
            # Mostramos las Ãºltimas lÃ­neas para depurar
            docker logs --tail 100 mc-test
            exit 1
          fi

      - name: ğŸ§¹ Limpieza
        if: always() # Se ejecuta aunque falle
        run: docker rm -f mc-test
        

      - name: ğŸ”” Notificar Ã‰xito a Discord
        uses: rjstone/discord-webhook-notify@v1
        if: success()
        with:
          severity: info
          username: "Minecraft CI"
          details: |
            âœ… **Test Exitoso**: El servidor de prueba arrancÃ³ correctamente.
            ğŸ”¹ **PR**: #${{ github.event.number }} - ${{ github.event.pull_request.title }}
            ğŸ”¹ **Autor**: ${{ github.actor }}
            ğŸ”¹ **Job**: [Ver Logs en GitHub](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: ğŸš¨ Notificar Error a Discord
        uses: rjstone/discord-webhook-notify@v1
        if: failure()
        with:
          severity: error
          username: "Minecraft CI"
          details: |
            âŒ **Test FALLIDO**: El servidor no pudo arrancar.
            ğŸ”¸ **PR**: #${{ github.event.number }} - ${{ github.event.pull_request.title }}
            ğŸ”¸ **Autor**: ${{ github.actor }}
            ğŸ”¸ **Job**: [Ver Logs y Errores](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK_URL_PRIVATE }}
