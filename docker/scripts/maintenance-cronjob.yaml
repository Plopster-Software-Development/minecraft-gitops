apiVersion: batch/v1
kind: CronJob
metadata:
  name: survival-server-maintenance
  namespace: minecraft
spec:
  schedule: "0 4 * * *" # Ejecutar a las 4:00 AM todos los dÃ­as
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: maintenace-cleaner
            image: busybox:latest
            command:
            - /bin/sh
            - -c
            - |
            - |
              echo "ðŸ§¹ Iniciando Mantenimiento..."
              
              # FunciÃ³n de limpieza segura: Mantiene siempre el backup mÃ¡s nuevo
              clean_safe() {
                  TARGET_DIR=$1
                  if [ -d "$TARGET_DIR" ]; then
                      echo "ðŸ“‚ Procesando: $TARGET_DIR"
                      # Ir al directorio para facilitar manejo de nombres
                      cd "$TARGET_DIR" || return
                      
                      # Obtener el archivo mÃ¡s reciente (zip o tar.gz)
                      # Is -t ordena por fecha descendente (primero = mÃ¡s nuevo)
                      NEWEST=$(ls -t | grep -E '\.(zip|tar\.gz)$' | head -n 1)
                      
                      if [ -n "$NEWEST" ]; then
                          echo "ðŸ›¡ï¸ Backup protegido (MÃ¡s reciente): $NEWEST"
                          
                          # Borrar archivos antiguos (>3 dÃ­as) PERO excluyendo el mÃ¡s reciente
                          # ! -name "$NEWEST" es la clave aquÃ­
                          find . -maxdepth 1 -type f \( -name "*.zip" -o -name "*.tar.gz" \) -mtime +3 ! -name "$NEWEST" -exec rm -v {} \;
                      else
                          echo "âš ï¸ No se encontraron backups vÃ¡lidos."
                      fi
                  else
                      echo "âš ï¸ Directorio no existe: $TARGET_DIR"
                  fi
              }

              # 1. Backups del Servidor
              clean_safe "/data/Backups"

              # 2. Backups de VotingPlugin
              echo "ðŸ—³ï¸ Limpiando VotingPlugin..."
              clean_safe "/data/plugins/VotingPlugin/Backups"
              
              # 3. Limpieza de Logs (Mantiene lÃ³gica simple > 1 dÃ­a)
              echo "ðŸ“œ Limpiando Logs antiguos..."
              if [ -d "/data/logs" ]; then
                find /data/logs -type f \( -name "*.log" -o -name "*.gz" \) -mtime +1 -exec rm {} \;
                echo "âœ… Logs procesados."
              fi
            volumeMounts:
            - name: datadir
              mountPath: /data
          restartPolicy: OnFailure
          volumes:
          - name: datadir
            persistentVolumeClaim:
              claimName: survival-server-minecraft-datadir
